generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPERADMIN
  MANAGER
  ADMIN
}

enum Language {
  UZ
  RU
  EN
}

enum ContentType {
  MOVIE
  SERIAL
}

enum BroadcastType {
  AD
  NOTIFICATION
  ALL
  PREMIUM
  FREE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  APPROVED
  REJECTED
}

enum BroadcastStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}
model User {
  id                 Int            @id @default(autoincrement())
  telegramId         String         @unique
  username           String?
  firstName          String?
  lastName           String?
  language           Language       @default(UZ)
  isPremium          Boolean        @default(false)
  premiumTill        DateTime?
  premiumExpiresAt   DateTime?
  isBlocked          Boolean        @default(false)
  blockedAt          DateTime?
  blockReason        String?
  warningCount       Int            @default(0)
  createdAt          DateTime       @default(now())
  lastActivity       DateTime       @default(now())
  
  payments           Payment[]
  watchHistory       WatchHistory[]
  
  @@index([telegramId])
  @@index([isPremium])
}


model Admin {
  id                Int        @id @default(autoincrement())
  telegramId        String     @unique
  username          String?
  role              AdminRole  @default(ADMIN)
  canAddAdmin       Boolean    @default(false)
  canDeleteContent  Boolean    @default(false)
  createdBy         String?
  createdAt         DateTime   @default(now())
  
  @@index([telegramId])
  @@index([role])
}


model Field {
  id                  Int               @id @default(autoincrement())
  name                String            @unique
  channelId           String            @unique
  channelLink         String?
  databaseChannelId   Int?
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  
  databaseChannel     DatabaseChannel?  @relation(fields: [databaseChannelId], references: [id])
  movies              Movie[]
  serials             Serial[]
  
  @@index([channelId])
}
model DatabaseChannel {
  id          Int      @id @default(autoincrement())
  channelId   String   @unique
  channelName String
  isActive    Boolean  @default(true)
  fields      Field[]
  
  createdAt   DateTime @default(now())
  
  @@index([channelId])
}
enum ChannelType {
  PUBLIC   // Public channel with ID/link and name
  PRIVATE  // Private channel with ID (requires member)
  EXTERNAL // External link (Instagram, YouTube, etc.)
}

model MandatoryChannel {
  id          Int         @id @default(autoincrement())
  type        ChannelType @default(PUBLIC)
  channelId   String?     // For PUBLIC/PRIVATE (nullable for EXTERNAL)
  channelName String
  channelLink String
  order       Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  
  @@index([isActive])
  @@index([type])
}
model Movie {
  id                Int            @id @default(autoincrement())
  code              Int            @unique
  title             String
  posterFileId      String
  videoFileId       String?
  videoMessageId    String?
  channelMessageId  Int?
  genre             String?
  language          String?
  quality           String?
  description       String?        @db.Text
  year              Int?
  imdb              Float?
  duration          Int?
  fieldId           Int
  views             Int            @default(0)
  shareLink         String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  field         Field          @relation(fields: [fieldId], references: [id])
  watchHistory  WatchHistory[]
  
  @@index([code])
  @@index([fieldId])
  @@index([views])
}
model Serial {
  id                  Int            @id @default(autoincrement())
  code                Int            @unique
  title               String
  posterFileId        String
  channelMessageId    Int?
  description         String?        @db.Text
  genre               String?
  totalEpisodes       Int            @default(0)
  hasCustomChannel    Boolean        @default(false)
  customChannelId     String?
  customChannelLink   String?
  fieldId             Int
  views               Int            @default(0)
  shareLink           String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  field               Field          @relation(fields: [fieldId], references: [id])
  episodes            Episode[]
  watchHistory        WatchHistory[]
  
  @@index([code])
  @@index([fieldId])
}
model Episode {
  id              Int      @id @default(autoincrement())
  serialId        Int
  episodeNumber   Int
  title           String?
  description     String?  @db.Text
  videoFileId     String
  videoMessageId  String
  views           Int      @default(0)
  createdAt       DateTime @default(now())
  
  serial          Serial   @relation(fields: [serialId], references: [id], onDelete: Cascade)
  
  @@unique([serialId, episodeNumber])
  @@index([serialId])
}
model WatchHistory {
  id          Int         @id @default(autoincrement())
  userId      Int
  contentType ContentType
  movieId     Int?
  serialId    Int?
  episodeId   Int?
  watchedAt   DateTime    @default(now())
  
  user        User        @relation(fields: [userId], references: [id])
  movie       Movie?      @relation(fields: [movieId], references: [id])
  serial      Serial?     @relation(fields: [serialId], references: [id])
  
  @@index([userId])
  @@index([watchedAt])
}
model Payment {
  id              Int           @id @default(autoincrement())
  userId          Int
  amount          Float
  duration        Int?
  currency        String        @default("UZS")
  receiptFileId   String?
  status          PaymentStatus @default(PENDING)
  provider        String        @default("payme")
  transactionId   String?       @unique
  processedBy     String?
  processedAt     DateTime?
  rejectionReason String?
  createdAt       DateTime      @default(now())
  
  user            User          @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([status])
  @@index([transactionId])
}
model PremiumSettings {
  id                  Int      @id @default(autoincrement())
  monthlyPrice        Float
  threeMonthPrice     Float
  sixMonthPrice       Float
  yearlyPrice         Float
  currency            String   @default("UZS")
  cardNumber          String
  cardHolder          String
  description         String   @db.Text
  updatedAt           DateTime @updatedAt
}
model BotSettings {
  id                     Int      @id @default(autoincrement())
  aboutBot               String   @db.Text
  supportUsername        String
  adminNotificationChat  String
  welcomeMessage         String   @db.Text
  updatedAt              DateTime @updatedAt
}
model Broadcast {
  id            Int              @id @default(autoincrement())
  type          BroadcastType
  messageText   String           @db.Text
  mediaFileId   String?
  fromChatId    String?          // For forward preservation
  fromMessageId Int?             // For forward preservation
  status        BroadcastStatus  @default(PENDING)
  sentCount     Int              @default(0)
  failedCount   Int              @default(0)
  completedAt   DateTime?
  createdBy     String
  createdAt     DateTime         @default(now())
  
  @@index([createdAt])
  @@index([status])
}
